#!/bin/sh

GPIO_EN_SPI=19
GPIO_EN_SPI=24

#YUN101 HW issue: GPIO24 is also SERIAL_OE, reenable it when done

if [ ! -d /sys/class/gpio/gpio$GPIO_EN_SPI ]; then
echo $GPIO_EN_SPI > /sys/class/gpio/export
fi

if [ ! -d /sys/class/gpio/gpio$GPIO_EN_UART ]; then
echo $GPIO_EN_UART > /sys/class/gpio/export
fi

echo out > /sys/class/gpio/gpio$GPIO_EN_SPI/direction
echo out > /sys/class/gpio/gpio$GPIO_EN_UART/direction

echo 0 > /sys/class/gpio/gpio$GPIO_EN_UART/value
echo 1 > /sys/class/gpio/gpio$GPIO_EN_SPI/value

avrdude  -q -q -c linuxgpio -C /etc/avrdude.conf -p m32u4 -U efuse:r:/tmp/efuse:d
read EFUSE < /tmp/efuse
rm -f /tmp/efuse
if [ "x$EFUSE" = "x203" ] # 203 = 0xCB
then
	avrdude -c linuxgpio -C /etc/avrdude.conf -p m32u4 -U lfuse:w:0xFF:m -U hfuse:w:0xD8:m -U efuse:w:0xCB:m -Uflash:w:$1:i $2
else
	avrdude -c linuxgpio -C /etc/avrdude.conf -p m32u4 -U lfuse:w:0xFF:m -U hfuse:w:0xD8:m -U efuse:w:0xFB:m -Uflash:w:$1:i $2
fi

echo 0 > /sys/class/gpio/gpio$GPIO_EN_SPI/value
echo 1 > /sys/class/gpio/gpio$GPIO_EN_UART/value
